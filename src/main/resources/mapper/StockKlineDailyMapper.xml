<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.like.a_share_screener.persistence.mapper.StockKlineDailyMapper">
	<select id="selectLatestTradeDate" resultType="java.time.LocalDate">
		SELECT MAX(trade_date)
		FROM stock_kline_daily
		WHERE code = #{code}
		  AND fqt = #{fqt}
	</select>

	<select id="selectRecentByCode" resultType="com.like.a_share_screener.persistence.entity.StockKlineDailyEntity">
		SELECT id, code, trade_date, open, high, low, close, volume, amount, amplitude_pct, change_pct, change_amt,
			   turnover_pct, fqt, created_at, updated_at
		FROM stock_kline_daily
		WHERE code = #{code}
		ORDER BY trade_date DESC
		LIMIT #{limit}
	</select>

	<insert id="upsertBatch">
		INSERT INTO stock_kline_daily
		(code, trade_date, open, high, low, close, volume, amount, amplitude_pct, change_pct, change_amt, turnover_pct, fqt)
		VALUES
		<foreach collection="items" item="item" separator=",">
			(#{item.code}, #{item.tradeDate}, #{item.open}, #{item.high}, #{item.low}, #{item.close},
			#{item.volume}, #{item.amount}, #{item.amplitudePct}, #{item.changePct}, #{item.changeAmt}, #{item.turnoverPct},
			#{item.fqt})
		</foreach>
		ON DUPLICATE KEY UPDATE
			open = VALUES(open),
			high = VALUES(high),
			low = VALUES(low),
			close = VALUES(close),
			volume = VALUES(volume),
			amount = VALUES(amount),
			amplitude_pct = VALUES(amplitude_pct),
			change_pct = VALUES(change_pct),
			change_amt = VALUES(change_amt),
			turnover_pct = VALUES(turnover_pct),
			fqt = VALUES(fqt),
			updated_at = CURRENT_TIMESTAMP
	</insert>
</mapper>
