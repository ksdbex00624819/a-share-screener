<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.like.a_share_screener.persistence.mapper.StockFactorMapper">
	<select id="selectLatestBarTime" resultType="java.time.LocalDateTime">
		SELECT MAX(bar_time)
		FROM stock_factor
		WHERE code = #{code}
		  AND timeframe = #{timeframe}
		  AND fqt = #{fqt}
	</select>

	<select id="selectNthNewestBarTime" resultType="java.time.LocalDateTime">
		SELECT bar_time
		FROM stock_factor
		WHERE code = #{code}
		  AND timeframe = #{timeframe}
		  AND fqt = #{fqt}
		ORDER BY bar_time DESC
		LIMIT 1 OFFSET #{offset}
	</select>

	<delete id="deleteOlderThan">
		DELETE FROM stock_factor
		WHERE code = #{code}
		  AND timeframe = #{timeframe}
		  AND fqt = #{fqt}
		  AND bar_time &lt; #{cutoff}
	</delete>

	<insert id="upsertBatch">
		INSERT INTO stock_factor
		(code, timeframe, bar_time, fqt, ma5, ma10, ma20, ma60, ema5, ema10, ema20, ema60, rsi14, atr14,
		macd, macd_signal, macd_hist, boll_mid, boll_up, boll_low, kdj_k, kdj_d, kdj_j, vol_ma5, vol_ma10,
		vol_ma20, vol_ma60, amt_ma20, vol_ratio20)
		VALUES
		<foreach collection="items" item="item" separator=",">
			(#{item.code}, #{item.timeframe}, #{item.barTime}, #{item.fqt}, #{item.ma5}, #{item.ma10},
			#{item.ma20}, #{item.ma60}, #{item.ema5}, #{item.ema10}, #{item.ema20}, #{item.ema60},
			#{item.rsi14}, #{item.atr14}, #{item.macd}, #{item.macdSignal}, #{item.macdHist}, #{item.bollMid},
			#{item.bollUp}, #{item.bollLow}, #{item.kdjK}, #{item.kdjD}, #{item.kdjJ}, #{item.volMa5},
			#{item.volMa10}, #{item.volMa20}, #{item.volMa60}, #{item.amtMa20}, #{item.volRatio20})
		</foreach>
		ON DUPLICATE KEY UPDATE
			ma5 = VALUES(ma5),
			ma10 = VALUES(ma10),
			ma20 = VALUES(ma20),
			ma60 = VALUES(ma60),
			ema5 = VALUES(ema5),
			ema10 = VALUES(ema10),
			ema20 = VALUES(ema20),
			ema60 = VALUES(ema60),
			rsi14 = VALUES(rsi14),
			atr14 = VALUES(atr14),
			macd = VALUES(macd),
			macd_signal = VALUES(macd_signal),
			macd_hist = VALUES(macd_hist),
			boll_mid = VALUES(boll_mid),
			boll_up = VALUES(boll_up),
			boll_low = VALUES(boll_low),
			kdj_k = VALUES(kdj_k),
			kdj_d = VALUES(kdj_d),
			kdj_j = VALUES(kdj_j),
			vol_ma5 = VALUES(vol_ma5),
			vol_ma10 = VALUES(vol_ma10),
			vol_ma20 = VALUES(vol_ma20),
			vol_ma60 = VALUES(vol_ma60),
			amt_ma20 = VALUES(amt_ma20),
			vol_ratio20 = VALUES(vol_ratio20),
			updated_at = CURRENT_TIMESTAMP
	</insert>
</mapper>
